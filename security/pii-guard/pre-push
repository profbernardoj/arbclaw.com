#!/usr/bin/env bash
# pre-push â€” Global git pre-push hook for PII Guard
# Part of EverClaw Security
# Install: git config --global core.hooksPath <path-to-git-hooks-dir>
set -euo pipefail

find_patterns_file() {
  local candidates=(
    "${PII_PATTERNS_FILE:-}"
    "$HOME/.openclaw/workspace/.pii-patterns.json"
    "./.pii-patterns.json"
  )
  for f in "${candidates[@]}"; do
    [[ -n "$f" && -f "$f" ]] && echo "$f" && return 0
  done
  return 1
}

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BOLD='\033[1m'
NC='\033[0m'

PATTERNS_FILE=$(find_patterns_file) || { exit 0; }

if ! command -v jq &>/dev/null; then
  echo -e "${YELLOW}âš  PII Guard: jq not installed â€” skipping${NC}"
  exit 0
fi

build_patterns() {
  local result=""
  while IFS= read -r line; do
    [[ -z "$line" ]] && continue
    local escaped
    escaped=$(printf '%s' "$line" | sed 's/[.[\*^$()+?{|]/\\&/g')
    if [[ -n "$result" ]]; then
      result="$result|$escaped"
    else
      result="$escaped"
    fi
  done < <(jq -r '
    (.names // [])[], (.emails // [])[], (.phones // [])[], (.wallets // [])[],
    (.organizations // [])[], (.people // [])[], (.websites // [])[], (.keywords // [])[]
  ' "$PATTERNS_FILE" 2>/dev/null)
  while IFS= read -r line; do
    [[ -z "$line" ]] && continue
    [[ -n "$result" ]] && result="$result|$line" || result="$line"
  done < <(jq -r '(.regex // [])[]' "$PATTERNS_FILE" 2>/dev/null)
  echo "$result"
}

GREP_PATTERN=$(build_patterns)
[[ -z "$GREP_PATTERN" ]] && exit 0

ZERO="0000000000000000000000000000000000000000"
found_pii=0
violations=""

while read -r local_ref local_sha remote_ref remote_sha; do
  [[ "$local_sha" == "$ZERO" ]] && continue

  if [[ "$remote_sha" == "$ZERO" ]]; then
    matches=$(git diff --cached "$local_sha" 2>/dev/null | grep -inE "$GREP_PATTERN" 2>/dev/null || true)
  else
    matches=$(git diff "$remote_sha" "$local_sha" 2>/dev/null | grep -inE "$GREP_PATTERN" 2>/dev/null || true)
  fi

  if [[ -n "$matches" ]]; then
    found_pii=1
    violations+="$matches"$'\n'
  fi
done

if [[ $found_pii -eq 1 ]]; then
  echo ""
  echo -e "${RED}${BOLD}ğŸš« PII GUARD: Push blocked â€” personal data detected!${NC}"
  echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo -e "${YELLOW}The following lines contain protected personal information:${NC}"
  echo ""
  echo "$violations" | head -30
  [[ $(echo "$violations" | wc -l) -gt 30 ]] && echo -e "${YELLOW}... and more (showing first 30)${NC}"
  echo ""
  echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "Patterns: ${PATTERNS_FILE}"
  echo -e "Bypass (CAUTION): git push ${BOLD}--no-verify${NC}"
  echo ""
  exit 1
fi

echo -e "${GREEN}âœ“ PII Guard: scan clean${NC}"
exit 0
